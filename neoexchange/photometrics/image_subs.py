"""
NEO exchange: NEO observing portal for Las Cumbres Observatory
Copyright (C) 2016-2019 LCO

image_subs.py -- Code to create weight images for SWarp from the rms images generated by SExtractor.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
"""
import os
import logging

import numpy as np
from astropy.io import fits

logger = logging.getLogger(__name__)

def create_weight_image(fits_file):

    """ Create a weight image for SWarp from the bad pixel mask (BPM) HDU
    of the original fits file, and the rms image generated by SExtractor. """

    if not os.path.exists(fits_file):
        logger.error("FITS file %s does not exist" % fits_file)
        return -1
    try:
        hdulist = fits.open(fits_file)
    except IOError as e:
        logger.error("Unable to open FITS image %s (Reason=%s)" % (fits_file, e))
        return -2

    # SCI HDU
    try:
        scidata = hdulist['SCI'].data
        sciheader = hdulist['SCI'].header
    except KeyError:
        logger.error("SCI HDU not found in %s." % fits_file)
        return -3

    # BPM HDU
    try:
        maskdata = hdulist['BPM'].data
    except KeyError as e:
        logger.error("BPM HDU not found in %s" % fits_file)
        return -4

    # RMS image
    if fits_file.endswith(".fz"):
        rms_file = fits_file.replace(".fits.fz", ".rms.fits")
    else:
        rms_file = fits_file.replace(".fits", ".rms.fits")
    if rms_file == fits_file:
        # We don't want to use the science data as rms data!
        logger.error("%s is a FITS file, but does not end in .fits or .fits.fz" % fits_file)
        return -5
    if not os.path.exists(rms_file):
        logger.error("RMS file %s does not exist" % rms_file)
        return -6
    try:
        rms_hdulist = fits.open(rms_file)
        rmsdata = rms_hdulist[0].data
    except IOError as e:
        logger.error("Unable to open RMS image %s (Reason=%s)" % (rms_file, e))
        return

    # Create boolean array based on mask
    boolean_mask = np.array(maskdata, dtype=bool)

    # Create an array to hold the weight values
    weightdata = np.empty_like(maskdata, dtype='<f4')
    weightdata[~boolean_mask] = 1 / rmsdata[~boolean_mask] ** 2
    weightdata[boolean_mask] = 0.

    # Additional mask based on saturation value
    try:
        max_satur = sciheader['MAXLIN']
    except KeyError:
            max_satur = sciheader['SATURATE']
    finally:
        satur_ind = scidata >= max_satur
        weightdata[satur_ind] = 0.

    # Create new weights FITS file
    del(sciheader['EXTNAME'])
    sciheader['L1FRMTYP'] = ('WEIGHT', 'Type of processed image')

    if fits_file.endswith(".fz"):
        weight_file = fits_file.replace(".fits.fz", ".weights.fits")
    else:
        weight_file = fits_file.replace(".fits", ".weights.fits")
    if weight_file == fits_file:
        # We don't want to overwrite the original file!
        logger.error("%s is a FITS file, but does not end in .fits or .fits.fz" % fits_file)
        return -5

    hdu = fits.PrimaryHDU(weightdata, sciheader)
    weight_hdulist = fits.HDUList(hdu)
    weight_hdulist.writeto(weight_file, overwrite = True, checksum = True)

    hdulist.close()
    rms_hdulist.close()

    return weight_file
